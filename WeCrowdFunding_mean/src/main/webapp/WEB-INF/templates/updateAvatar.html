<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="stylesheet" th:href="@{/bootstrap/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/font-awesome.min.css}">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <style>
        #footer {
            padding: 15px 0;
            background: #fff;
            border-top: 1px solid #ddd;
            text-align: center;
        }

        #topcontrol {
            color: #fff;
            z-index: 99;
            width: 30px;
            height: 30px;
            font-size: 20px;
            background: #222;
            position: relative;
            right: 14px !important;
            bottom: 11px !important;
            border-radius: 3px !important;
        }

        #topcontrol:after {
            /*top: -2px;*/
            left: 8.5px;
            content: "\f106";
            position: absolute;
            text-align: center;
            font-family: FontAwesome;
        }

        #topcontrol:hover {
            color: #fff;
            background: #18ba9b;
            -webkit-transition: all 0.3s ease-in-out;
            -moz-transition: all 0.3s ease-in-out;
            -o-transition: all 0.3s ease-in-out;
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body>

<div th:replace="~{commons/maincommons::topbar}"></div>

<div class="container-fluid">
    <div class="row">
        <div th:replace="~{commons/maincommons::sidebar}"></div>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="glyphicon glyphicon-th"></i> 会员中心</h3>
                </div>
                <div class="panel-body">

                    <div class="col-md-12">
                        <div class="col-md-3"></div>
                        <div class="col-md-6">
                            <!--    Striped Rows Table  -->
                            <form method="post" enctype ="multipart/form-data">
                                <div class="panel panel-default panel-body text-center" style="width: 780px;height: 800px;padding-top: 120px">
                                    <input id="id" type="hidden" name="uid" th:if="${session.user!=null}" th:value="${session.user.id}">
                                    <input id="usertype" type="hidden" name="usertype" th:if="${session.user!=null}" th:value="${session.user.usertype}">

                                    <div class="panel-body col-md-6" >
                                        <div  id="portrait" style="position: relative" onmouseover="javascript:portraitin()" onmouseout="javascript:portraitout()" >
                                            <div style="border-radius: 10px;width: 200px;height: 200px;border: gainsboro solid 1px;padding-top: 0;position: absolute;left: 60px;top: 0"></div>
                                            <img th:src="@{/img/12.png}" alt="选择并上传头像" id="avatar_img"
                                                 style="border-radius: 10px;width: 200px;height: 200px;padding-top: 0;position: absolute;left: 60px;top: 0;"/>

                                            <input type="file" id="avatar_file" name="file" accept="image/jpg,image/png,image/gif"
                                                   style="position: absolute;border-radius: 10px;width: 200px;height: 200px;position: absolute;left: 60px;top: 0;opacity: 0"/>
                                        </div>
                                        <!--<i class="fa fa-refresh fa-1x" onclick="javascript:history.go(0)" style="padding-top: 210px;margin-left: 0px">刷新</i>-->
                                    </div>

                                    <div class="panel-body col-md-6">
                                        <div style="border-radius: 10px;width: 200px;height: 200px;border: gainsboro solid 1px;margin-left: 60px">
                                            <div th:if="${session.user.avatar!=null}">
                                                <img th:src="@{/img/avatar/{image_name}(image_name=${session.user.avatar})}"  alt="..." class="img-circle" style="width: 120px;height: 120px;margin-top: 40px">
                                            </div>
                                            <div th:if="${session.user.avatar==null}">
                                                <img th:src="@{/img/services-box1.jpg}" alt="..." class="img-circle" style="width: 120px;height: 120px;margin-top: 40px">
                                            </div>
                                        </div>
                                    </div>
                                    <p style="margin-top: 250px;font-size: 15px">请选择图片上传：大小180 * 180像素支持JPG、PNG等格式，图片需小于2M</p>
                                    <br>
                                    <a id="updatebtn" onclick="javascript:updateAvatar()" class="btn btn-default" role="button" disabled="block">更新</a>
                                    <a  class="btn btn-default" role="button" onclick="javascript:history.go(-1)">取消</a>
                                </div>
                            </form>
                            <!--  End  Striped Rows Table  -->
                            <div class="col-md-3"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>
<div class="container" style="margin-top:20px;">
    <div class="row clearfix">
        <div class="col-md-12 column">
            <div id="footer">
                <div class="footerNav">
                    <a rel="nofollow" href="http://www.atguigu.com">关于我们</a> | <a rel="nofollow"
                                                                                  href="http://www.atguigu.com">服务条款</a>
                    | <a rel="nofollow" href="http://www.atguigu.com">免责声明</a> | <a rel="nofollow"
                                                                                    href="http://www.atguigu.com">网站地图</a>
                    | <a rel="nofollow" href="http://www.atguigu.com">联系我们</a>
                </div>
                <div class="copyRight">
                    Copyright ?2017-2017atguigu.com 版权所有
                </div>
            </div>

        </div>
    </div>
</div>
<script th:src="@{/jquery/jquery-2.1.1.min.js}"></script>
<script th:src="@{/bootstrap/js/bootstrap.min.js}"></script>
<script th:src="@{/script/layer.js}"></script>
<script type="text/javascript">
    $(function () {
        $(".list-group-item").click(function () {
            if ($(this).find("ul")) {
                $(this).toggleClass("tree-closed");
                if ($(this).hasClass("tree-closed")) {
                    $("ul", this).hide("fast");
                } else {
                    $("ul", this).show("fast");
                }
            }
        });
    })
    function getContextPath(){
        var pathName = document.location.pathname;
        var index = pathName.substr(1).indexOf("/");
        var result = pathName.substr(0,index+1);
        return result;
    }
    var contextPath = getContextPath();
    //头像效果
    function portraitin() {
        $("#portrait").css({"filter":"brightness(0.9)"})
        // $(".div1").css({"backgroundColor":"green","border":"1px solid red"});
    }
    function portraitout() {
        $("#portrait").css({"filter":"brightness(1)"})
    }
    // 头像预览
    $("#avatar_file").change(function () {
        // 获取上传文件对象
        var file = $(this)[0].files[0];
        // 读取文件URL
        var reader = new FileReader();
        reader.readAsDataURL(file);
        $("#fileicon").css({"display":"none"})

        // 阅读文件完成后触发的事件
        reader.onload = function () {
            // 读取的URL结果：this.result
            $("#avatar_img").attr("src", this.result);
            $(".img-circle").attr("src", this.result);
        }
        $("#updatebtn").removeAttr("disabled");
    });
    function updateAvatar() {
        var path = contextPath +"/user/updateAvatar"
        var file = $("#avatar_file")[0].files[0];
        var id = $("#id").val();
        var usertype = $("#usertype").val();
        var formData = new FormData();
        formData.append("file",file);
        formData.append("id",id);
        formData.append("usertype",usertype);
        // alert(formData.length())
        $.ajax({
            url: path,
            type: "POST",
            data: formData,
            /**
             *必须false才会自动加上正确的Content-Type
             */
            contentType: false,
            /**
             * 必须false才会避开jQuery对 formdata 的默认处理
             * XMLHttpRequest会对 formdata 进行正确的处理
             */
            processData: false,
            cache: false,
            success: function (data) {
                if(data==true){
                    layer.msg('上传成功', {
                            skin: 'layui-layer-molv', //样式类名
                            closeBtn: 0,
                            icon: 1,
                            time: 1000 //2秒关闭（如果不配置，默认是3秒）
                    });
                    setTimeout(function () {
                        window.location.reload()
                    },1000)
                }else{
                    layer.msg('上传失败，请稍后重试', {
                            skin: 'layui-layer-molv', //样式类名
                            closeBtn: 0,
                            icon: 2,
                            time: 1000 //2秒关闭（如果不配置，默认是3秒）
                        }
                    );
                }
            },error:function () {
                layer.msg('服务器错误', {
                        skin: 'layui-layer-molv', //样式类名
                        closeBtn: 0,
                        icon: 2,
                        time: 1000 //2秒关闭（如果不配置，默认是3秒）
                    }
                );
            }
        })
    }
</script>
</body>
</html>